// ============================================================================
// FILE: lib/services/api_services.dart
// COPY ENTIRE FILE TO YOUR FLUTTER PROJECT
// ============================================================================

import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ApiService {
  // ‚ö†Ô∏è SESUAIKAN BASEURL DENGAN ENVIRONMENT ANDA ‚ö†Ô∏è
  
  // Untuk Android Emulator (DEFAULT):
  static const String baseUrl = "http://10.0.2.2:8000/api";
  
  // Untuk iOS Simulator, gunakan ini:
  // static const String baseUrl = "http://localhost:8000/api";
  
  // Untuk Device Fisik, ganti 192.168.1.100 dengan IP mesin dev Anda:
  // static const String baseUrl = "http://192.168.1.100:8000/api";

  static final http.Client _client = http.Client();
  static final _prefs = SharedPreferences.getInstance();

  // ==================== TOKEN MANAGEMENT ====================

  /// Simpan token ke SharedPreferences
  static Future<void> _saveToken(String token) async {
    final prefs = await _prefs;
    await prefs.setString('auth_token', token);
    print('[ApiService] Token saved');
  }

  /// Ambil token dari SharedPreferences
  static Future<String?> getToken() async {
    final prefs = await _prefs;
    return prefs.getString('auth_token');
  }

  /// Hapus token dari SharedPreferences
  static Future<void> clearToken() async {
    final prefs = await _prefs;
    await prefs.remove('auth_token');
    print('[ApiService] Token cleared');
  }

  /// Check apakah user sudah login (ada token)
  static Future<bool> isLoggedIn() async {
    final token = await getToken();
    return token != null && token.isNotEmpty;
  }

  // ==================== HEADERS ====================

  /// Header untuk request dengan/tanpa token
  static Future<Map<String, String>> _getHeaders({bool includeAuth = true}) async {
    final headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    };

    if (includeAuth) {
      final token = await getToken();
      if (token != null) {
        headers['Authorization'] = 'Bearer $token';
      }
    }

    return headers;
  }

  // ==================== AUTH ENDPOINTS ====================

  /// üìù REGISTER - Daftar user baru
  /// 
  /// Request:
  /// {
  ///   "name": "John Doe",
  ///   "email": "john@example.com",
  ///   "password": "password123",
  ///   "password_confirmation": "password123"
  /// }
  ///
  /// Response Success (201):
  /// {
  ///   "message": "Registrasi berhasil",
  ///   "data": {
  ///     "user": { "id": 1, "name": "John Doe", ... },
  ///     "token": "5|OVxPk..."
  ///   }
  /// }
  static Future<Map<String, dynamic>?> register({
    required String name,
    required String email,
    required String password,
    required String passwordConfirmation,
  }) async {
    try {
      print('[ApiService] Registering: $email');

      final response = await _client.post(
        Uri.parse('$baseUrl/register'),
        headers: await _getHeaders(includeAuth: false),
        body: jsonEncode({
          'name': name,
          'email': email,
          'password': password,
          'password_confirmation': passwordConfirmation,
        }),
      ).timeout(Duration(seconds: 30));

      if (response.statusCode == 201 || response.statusCode == 200) {
        final data = jsonDecode(response.body);
        print('[ApiService] Register success: ${data['message']}');

        // Simpan token jika ada
        if (data['data']?['token'] != null) {
          await _saveToken(data['data']['token']);
        }

        return data;
      } else if (response.statusCode == 422) {
        // Validation error
        final errorData = jsonDecode(response.body);
        print('[ApiService] Validation Error: ${errorData['errors']}');
        return null;
      } else {
        print('[ApiService] Register Error: ${response.statusCode}');
        print('[ApiService] Response: ${response.body}');
        return null;
      }
    } catch (e) {
      print('[ApiService] Register Exception: $e');
      return null;
    }
  }

  /// üîê LOGIN - Login dengan email & password
  ///
  /// Request:
  /// {
  ///   "email": "john@example.com",
  ///   "password": "password123"
  /// }
  ///
  /// Response Success (200):
  /// {
  ///   "message": "Login berhasil",
  ///   "data": {
  ///     "user": { "id": 1, "name": "John Doe", ... },
  ///     "token": "5|OVxPk..."
  ///   }
  /// }
  static Future<Map<String, dynamic>?> login({
    required String email,
    required String password,
  }) async {
    try {
      print('[ApiService] Logging in: $email');

      final response = await _client.post(
        Uri.parse('$baseUrl/login'),
        headers: await _getHeaders(includeAuth: false),
        body: jsonEncode({
          'email': email,
          'password': password,
        }),
      ).timeout(Duration(seconds: 30));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        print('[ApiService] Login success: ${data['message']}');

        // Simpan token jika ada
        if (data['data']?['token'] != null) {
          await _saveToken(data['data']['token']);
        }

        return data;
      } else {
        print('[ApiService] Login Error: ${response.statusCode}');
        print('[ApiService] Response: ${response.body}');
        return null;
      }
    } catch (e) {
      print('[ApiService] Login Exception: $e');
      return null;
    }
  }

  /// üë§ GET PROFILE - Ambil data profil user saat ini (Protected)
  ///
  /// Headers Required:
  /// Authorization: Bearer <token>
  ///
  /// Response Success (200):
  /// {
  ///   "message": "Profil user",
  ///   "data": {
  ///     "id": 1,
  ///     "name": "John Doe",
  ///     "email": "john@example.com",
  ///     "role": "pengunjung",
  ///     "created_at": "2025-11-13T...",
  ///     "updated_at": "2025-11-13T..."
  ///   }
  /// }
  static Future<Map<String, dynamic>?> getProfile() async {
    try {
      print('[ApiService] Getting profile');

      final response = await _client.get(
        Uri.parse('$baseUrl/user'),
        headers: await _getHeaders(includeAuth: true),
      ).timeout(Duration(seconds: 30));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        print('[ApiService] Profile fetched: ${data['message']}');
        return data;
      } else if (response.statusCode == 401) {
        // Token expired atau invalid
        print('[ApiService] Token expired (401)');
        await clearToken();
        return null;
      } else {
        print('[ApiService] Get Profile Error: ${response.statusCode}');
        print('[ApiService] Response: ${response.body}');
        return null;
      }
    } catch (e) {
      print('[ApiService] Get Profile Exception: $e');
      return null;
    }
  }

  /// üö™ LOGOUT - Logout & revoke token (Protected)
  ///
  /// Headers Required:
  /// Authorization: Bearer <token>
  ///
  /// Response Success (200):
  /// {
  ///   "message": "Logout berhasil"
  /// }
  static Future<bool> logout() async {
    try {
      print('[ApiService] Logging out');

      final response = await _client.post(
        Uri.parse('$baseUrl/logout'),
        headers: await _getHeaders(includeAuth: true),
      ).timeout(Duration(seconds: 30));

      if (response.statusCode == 200) {
        print('[ApiService] Logout success');
        // Hapus token dari storage
        await clearToken();
        return true;
      } else {
        print('[ApiService] Logout Error: ${response.statusCode}');
        // Tetap hapus token meski error
        await clearToken();
        return false;
      }
    } catch (e) {
      print('[ApiService] Logout Exception: $e');
      // Tetap hapus token meski error
      await clearToken();
      return false;
    }
  }

  // ==================== OTHER ENDPOINTS ====================

  /// üìÖ GET JADWAL - Ambil jadwal peminjaman berdasarkan tanggal
  ///
  /// Parameters:
  /// - date: String format "YYYY-MM-DD"
  ///
  /// Response Success (200):
  /// [
  ///   { "id": 1, "ruang": "Ruang A", "waktu": "08:00", ... },
  ///   { "id": 2, "ruang": "Ruang B", "waktu": "10:00", ... }
  /// ]
  static Future<List<dynamic>?> getJadwalByDate(String date) async {
    try {
      print('[ApiService] Getting jadwal for date: $date');

      final response = await _client.get(
        Uri.parse('$baseUrl/peminjaman/jadwal/$date'),
        headers: await _getHeaders(),
      ).timeout(Duration(seconds: 30));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        print('[ApiService] Jadwal fetched');
        return data['data'] ?? [];
      } else {
        print('[ApiService] Get Jadwal Error: ${response.statusCode}');
        return null;
      }
    } catch (e) {
      print('[ApiService] Get Jadwal Exception: $e');
      return null;
    }
  }

  /// üìã GET PEMINJAMAN DETAIL - Ambil detail peminjaman berdasarkan ID
  ///
  /// Parameters:
  /// - id: int peminjaman ID
  ///
  /// Response Success (200):
  /// {
  ///   "id": 1,
  ///   "user_id": 1,
  ///   "ruang_id": 1,
  ///   "tanggal_mulai": "2025-11-13",
  ///   "tanggal_selesai": "2025-11-13",
  ///   "status": "approved",
  ///   ...
  /// }
  static Future<Map<String, dynamic>?> getPeminjamanDetail(int id) async {
    try {
      print('[ApiService] Getting peminjaman detail: $id');

      final response = await _client.get(
        Uri.parse('$baseUrl/peminjaman/$id'),
        headers: await _getHeaders(),
      ).timeout(Duration(seconds: 30));

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        print('[ApiService] Peminjaman detail fetched');
        return data['data'];
      } else {
        print('[ApiService] Get Peminjaman Detail Error: ${response.statusCode}');
        return null;
      }
    } catch (e) {
      print('[ApiService] Get Peminjaman Detail Exception: $e');
      return null;
    }
  }

  // ==================== HELPER METHODS ====================

  /// Get error message dari response
  static String getErrorMessage(dynamic response) {
    try {
      if (response is String) {
        final data = jsonDecode(response);
        if (data['message'] != null) return data['message'];
        if (data['errors'] != null) {
          final errors = data['errors'];
          if (errors is Map) {
            return errors.values.first.toString();
          }
        }
      }
    } catch (e) {
      //
    }
    return 'Terjadi kesalahan';
  }
}

// ============================================================================
// USAGE EXAMPLES
// ============================================================================

/*

// 1. REGISTER
final registerResult = await ApiService.register(
  name: 'John Doe',
  email: 'john@example.com',
  password: 'password123',
  passwordConfirmation: 'password123',
);

if (registerResult != null) {
  print('Register success!');
  print('Token: ${registerResult['data']['token']}');
} else {
  print('Register failed');
}

// 2. LOGIN
final loginResult = await ApiService.login(
  email: 'john@example.com',
  password: 'password123',
);

if (loginResult != null) {
  print('Login success!');
  print('User: ${loginResult['data']['user']['name']}');
  // Token sudah otomatis disimpan
}

// 3. CHECK IF LOGGED IN
final isLoggedIn = await ApiService.isLoggedIn();
print('Is logged in: $isLoggedIn');

// 4. GET PROFILE
final profile = await ApiService.getProfile();
if (profile != null) {
  print('Profile: ${profile['data']['name']}');
}

// 5. LOGOUT
final logoutSuccess = await ApiService.logout();
if (logoutSuccess) {
  print('Logout success, token cleared');
}

// 6. GET JADWAL
final jadwal = await ApiService.getJadwalByDate('2025-11-13');
if (jadwal != null) {
  for (var item in jadwal) {
    print('Jadwal: ${item['ruang']} - ${item['waktu']}');
  }
}

// 7. GET PEMINJAMAN DETAIL
final detail = await ApiService.getPeminjamanDetail(1);
if (detail != null) {
  print('Peminjaman: ${detail['status']}');
}

*/
