[project]
name = "sewa-ruang"
link = ""

[build]
builder = "NIXPACKS"

# Setup phase: install Node, PHP, Composer
[phases.setup]
nixPkgs = ["nodejs_20", "php83", "composer"]

# Install phase: install dependencies & build assets
[phases.install]
cmds = [
  # Set npm cache
  "npm config set cache /tmp/npm-cache --global",

  # Backup node_modules (optional)
  "mv node_modules node_modules_bak 2>/dev/null || true",

  # Install node packages
  "npm install --legacy-peer-deps --no-fund --omit=dev",

  # Build Vite assets
  "npm run build",

  # Fix manifest location
  "node scripts/fix-manifest.js",

  # Install PHP dependencies
  "composer install --no-dev --optimize-autoloader"
]

# Environment variables
[env]
# Laravel config
APP_ENV = "production"
APP_DEBUG = "false"
APP_KEY = "base64:Uu8K8AnOpeQfYZ7p8VPol+l36q+0QaodqIpkvN5MjSw="
APP_URL = "https://sewa-ruang.up.railway.app"
ASSET_URL = "https://sewa-ruang.up.railway.app"
LOG_CHANNEL = "stack"
LOG_DEPRECATIONS_CHANNEL = "null"
LOG_LEVEL = "debug"

# Database
DB_CONNECTION = "mysql"
DB_HOST = "containers-us-west-140.railway.app"
DB_PORT = "3306"
DB_DATABASE = "railway"
DB_USERNAME = "root"
DB_PASSWORD = ""

# Vite/NPM cache dirs
VITE_CACHE_DIR = "/tmp/vite-cache"
NPM_CONFIG_CACHE = "/tmp/npm-cache"

# Port untuk web service
PORT = "8080"

# Force production build
NODE_ENV = "production"

# Start phase
[deploy]
# PHP built-in server (untuk testing cepat; untuk production lebih baik pakai NGINX + PHP-FPM)
startCommand = "php -S 0.0.0.0:$PORT -t public"
